# Code Index MCP 质量提升任务清单

基于 `plans.md` 提取的具体实施任务，按照三个阶段组织。

## 第一阶段：复杂度整治（第 1-2 周）

### 🔄 复杂函数分析与重构

- [x] 确认 `project_settings.py.__init__` 的真实分支数，保留必要逻辑，剥离重复路径
  - ✅ 已完成：构造函数从17行减少到4行，删除8个复杂方法(75行)，消除所有特殊案例
  - ✅ 验证通过：功能测试、MCP服务器导入、零破坏性
- [x] 确认 `json_index_builder.py.build_index` 的真实分支数，保留必要逻辑，剥离重复路径
  - ✅ 已完成：消除并行/串行处理中的重复逻辑，提取 `_process_file_result()` 统一处理
  - ✅ 优化：添加 `_get_optimal_workers()` 消除 max_workers 特殊情况处理
  - ✅ 验证通过：语法检查正确，逻辑结构保持原有行为，零破坏性
- [ ] 确认 `rust_strategy.py.parse_file` 的真实分支数，保留必要逻辑，剥离重复路径
- [ ] 确认 `typescript_strategy.py.parse_file` 的真实分支数，保留必要逻辑，剥离重复路径

### 🔧 代码去重与重构

- [ ] 把通用的忽略规则、文件遍历逻辑放到共享助手里，避免再次复制粘贴
- [ ] 重构完成后跑实际索引任务，确认无回归

## 第二阶段：类型错误清理（第 2-4 周）

### 🏗️ 类型系统完善

- [ ] 把 MyPy 加入 CI，阻止新增错误
- [ ] 优先处理 `Optional` 与 `Union` 的判空场景，按真实数据流补注解
- [ ] 对抽象基类补足 `ABC` 定义，确保运行时行为与静态检查一致
- [ ] MyPy 归零后留守自检脚本，保证日常运行简单

## 第三阶段：测试与性能验证（第 4-6 周）

### 🧪 测试体系建设

- [ ] 建立最小化的 `pytest` 回归套件，覆盖索引构建与搜索查询主流程

### 📊 性能基线与优化

- [ ] 使用 `scripts/measure_index_baseline.py` 记录索引耗时与内存基线
- [ ] 通过现有数据结构优化 IO 性能

## 风险控制与质量保证

### ✅ 持续验证

- [ ] 确保每次改动都跑完整测试和索引验证
- [ ] 保持 MCP 接口兼容性，必要时新增版本标志
- [ ] 变更同步到 `ARCHITECTURE.md`，避免文档漂移

## 质量指标目标

- **Pylint**: 从 9.09 提升到 ≥9.50
- **MyPy**: 显式类型错误从 54 降到 0
- **复杂度**: 重点函数分支数控制在 10 以内
- **索引耗时**: 在当前基准项目上降低 20%

## 当前基线数据（2025-09-18）

- 全量索引耗时：1.14s
- Python 内存峰值：3.69 MiB
- 索引文件数：150，符号总数：986
- 识别语言：12种主流语言

---

**任务提取时间**: 2025-01-18
**预计完成时间**: 2025-03-28 (10周)
**基于文件**: plans.md