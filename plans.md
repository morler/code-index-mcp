﻿# Code Index MCP 代码质量提升计划



## 项目现状评估



### 当前版本信息

- **版本**: 2.3.2

- **架构**: 基于 SCIP 的代码索引服务

- **支持语言**: Python, JavaScript, TypeScript, Java, Go, Objective-C, Zig 等主流语言

- **主要功能**: 代码索引、符号搜索、文件监控、符号分析



### 代码质量分析结果



#### 🔴 高优先级问题

1. **函数复杂度偏高**: 仍有多个模块超过分支或语句阈值，维护成本高。

2. **类型系统缺陷**: MyPy 报告大量错误，暴露真实的可空问题。

3. **重复逻辑**: 索引与搜索流程存在重复路径，导致修复成本翻倍。



#### 🟡 中优先级问题

1. **性能瓶颈**: 部分语言在大仓库上索引时间明显偏长。

2. **测试覆盖不足**: 关键路径缺少可重复的回归测试。

3. **文档同步滞后**: 代码演进未及时更新设计文档。



## 质量提升目标



### 代码质量指标

- **Pylint**: 从 9.09 拉到 ≥9.50，先消除真实告警。

- **MyPy**: 显式类型错误从 54 降到 0，保持持续检查。

- **复杂度**: 将重点函数分支数控制在 10 以内。

- **重复率**: 针对索引/搜索路径做精确去重，避免再次分叉。



### 性能与稳定指标

- **索引耗时**: 在当前基准项目上至少降低 20%，确保有数据支撑。

- **内存占用**: 先量化，再决定是否需要结构调整。

- **大项目兼容性**: 确认 100K 文件场景可以完整跑通，无需引入新架构。



## 当前性能基线（2025-09-18T09:33:54Z）



- 基线环境：Windows 11 + Python 3.10 (.venv)

- 执行方式：直接调用 code_index_mcp.indexing.get_index_manager().refresh_index()

- 全量索引耗时：1.14 s

- Python 内存峰值：3.69 MiB（tracemalloc）

- Python 当前占用：2.20 MiB

- 进程 RSS：60.5 MiB

- 索引文件数：150，符号总数：986

- 识别语言：go / h / java / javascript / json / markdown / objective-c / python / rust / typescript / xml / zig



## 精简实施计划



### 第一阶段：复杂度整治（第 1-2 周）

- [ ] 逐一确认 `project_settings.py.__init__`、`json_index_builder.py.build_index`、`rust_strategy.py.parse_file`、`typescript_strategy.py.parse_file` 的真实分支数，保留必要逻辑，剥离重复路径。

- [ ] 把通用的忽略规则、文件遍历逻辑放到共享助手里，避免再次复制粘贴。

- [ ] 重构完成后跑实际索引任务，确认无回归。



### 第二阶段：类型错误清理（第 2-4 周）

- [ ] 先把 MyPy 加入 CI，阻止新增错误。

- [ ] 优先处理 `Optional` 与 `Union` 的判空场景，按真实数据流补注解。

- [ ] 对抽象基类补足 `ABC` 定义，确保运行时行为与静态检查一致。

- [ ] MyPy 归零后留守自检脚本，保证日常运行简单。



### 第三阶段：测试与性能验证（第 4-6 周）

- [ ] 建立最小化的 `pytest` 回归套件，覆盖索引构建与搜索查询主流程即可，不搞层层目录。

- [ ] 使用 `scripts/measure_index_baseline.py` 记录索引耗时与内存基线，必要时写入 `--output` 结果文件以便后续对比。

- [ ] 性能问题先通过现有数据结构优化 IO，暂不引入增量索引或线程池，除非数据证明必要。



## 风险控制

- 每次改动都跑 `uv run python -m pytest test/` 和一次完整索引，确保用户体验不受影响。

- 对外暴露的 MCP 接口保持兼容，必要时新增版本标志。

- 变更同步到 `ARCHITECTURE.md`，避免文档漂移。



## 预期成果

- 核心路径更易读，修改无需硬着头皮。

- 类型错误清零，减少线上崩溃可能。

- 有数据的性能优化决策，不再凭空设计。

- 回归流程简单可重复，降低合入风险。



---



**计划制定时间**: 2025-01-18

**预计完成时间**: 2025-03-28 (10 周)

**质量负责人**: 开发团队

**审查周期**: 每周进度审查


